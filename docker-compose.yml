version: '3.8'

services:
  # ================================================================
  # PostgreSQL Database Service
  # ================================================================
  # 
  # Security & Network Design:
  #   - REMOVED: ports: ["5432:5432"]
  #   - WHY: Only Docker internal network (app_network) needs DB access
  #   - FastAPI container can access DB via container name DNS
  #   - No need to expose DB to host machine (security risk)
  #   - If debugging needed, use: docker exec transparent_search_postgres psql -U app_user -d transparent_search
  #
  # Docker Network Communication:
  #   Container names auto-resolve via Docker DNS within the same network
  #   Example: transparent_search_app uses transparent_search_db:5432
  #   (NOT localhost:5432 - that wouldn't work in containers)
  #
  transparent_search_db:
    image: postgres:16
    container_name: transparent_search_postgres
    environment:
      POSTGRES_DB: transparent_search
      POSTGRES_USER: app_user
      POSTGRES_PASSWORD: app_password
    # REMOVED ports section - only Docker internal network access
    volumes:
      - db_data:/var/lib/postgresql/data
    networks:
      - app_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U app_user -d transparent_search"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ================================================================
  # Redis Cache Service
  # ================================================================
  # 
  # Security & Network Design:
  #   - REMOVED: ports: ["6379:6379"]
  #   - WHY: Only Docker internal network (app_network) needs cache access
  #   - FastAPI container can access Redis via container name DNS
  #   - No need to expose Redis to host machine (major security risk - no auth by default)
  #   - If debugging needed, use: docker exec transparent_search_redis redis-cli
  #
  # AOF (Append-Only File) Persistence:
  #   command: redis-server --appendonly yes
  #   - Data persists across container restarts
  #   - Stored in cache_data volume
  #   - Clean restart: docker-compose down -v (removes data)
  #
  transparent_search_cache:
    image: redis:7-alpine
    container_name: transparent_search_redis
    # REMOVED ports section - only Docker internal network access
    command: redis-server --appendonly yes
    volumes:
      - cache_data:/data
    networks:
      - app_network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ================================================================
  # FastAPI Application Service
  # ================================================================
  # 
  # Port Exposure:
  #   - ONLY 8080 exposed to host (FastAPI API endpoint)
  #   - This is the single entry point for users
  #   - DB and Cache remain internal-only (not accessible from host)
  #
  # Internal Communication via Docker Network (app_network):
  #   - DATABASE_URL: postgresql+asyncpg://app_user:app_password@transparent_search_db:5432/transparent_search
  #     ^ 'transparent_search_db' is the container name (Docker DNS resolves it)
  #   - REDIS_URL: redis://transparent_search_cache:6379/0
  #     ^ 'transparent_search_cache' is the container name (Docker DNS resolves it)
  #
  # Docker Network Architecture (Bridge Network):
  #   - app_network (bridge) connects all three containers
  #   - Containers can communicate using container names as hostnames
  #   - Host cannot directly access DB or Cache (intentional)
  #   - Only port 8080 bridges to host machine
  #
  transparent_search_app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: transparent_search_app
    environment:
      # Container names used for DNS resolution within Docker network
      # (NOT localhost - localhost would refer to the container itself, not other services)
      DATABASE_URL: postgresql+asyncpg://app_user:app_password@transparent_search_db:5432/transparent_search
      REDIS_URL: redis://transparent_search_cache:6379/0
      LOG_LEVEL: INFO
    ports:
      # ONLY expose API port - this is the entry point for users
      - "8080:8080"
    depends_on:
      transparent_search_db:
        condition: service_healthy
      transparent_search_cache:
        condition: service_healthy
    networks:
      - app_network
    volumes:
      - .:/app
    command: sh -c "python -m app.migrations && python -m uvicorn app.main:app --host 0.0.0.0 --port 8080"

# ================================================================
# Persistent Volumes
# ================================================================
volumes:
  db_data:
    # PostgreSQL database files
    # Survives docker-compose down (use -v flag to delete)
  cache_data:
    # Redis AOF (Append-Only File) for persistence
    # Survives docker-compose down (use -v flag to delete)

# ================================================================
# Docker Network
# ================================================================
networks:
  app_network:
    driver: bridge
    # All containers join this network and can communicate by container name
    # Examples:
    #   - transparent_search_app can reach transparent_search_db via DNS
    #   - transparent_search_app can reach transparent_search_cache via DNS
    #   - Host can ONLY access transparent_search_app:8080
    #   - Host CANNOT access DB:5432 or Cache:6379 (intentional security design)
